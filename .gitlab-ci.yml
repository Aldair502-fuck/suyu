variables:
  PR_NUMBER: "pr$CI_MERGE_REQUEST_IID"

stages:
  - format
  - android
  - build

clang-format:
  stage: format
  image: suyuemu/cibuild:linux-x64
  variables:
    RELEASE_NAME: mainline
  script:
    - git submodule update --init --depth 1 --recursive
    - bash .ci/scripts/format/script.sh

build-linux:
  stage: build
  image: suyuemu/cibuild:linux-x64
  resource_group: linux-ci
  variables:
    RELEASE_NAME: mainline
  script:
    - git submodule update --init --depth 1 --recursive
    - bash .ci/scripts/linux/docker.sh
    - bash .ci/scripts/linux/upload.sh
  artifacts:
    paths:
      - artifacts/*

android:
  stage: android
  image: ubuntu:latest
  before_script:
    - apt-get -qq update
    - apt-get -y -qq install wget ccache apksigner glslang-dev glslang-tools git sdkmanager android-sdk bash openjdk-21-jdk openjdk-21-jre build-essential g++ python3-dev autotools-dev libicu-dev libbz2-dev
    - mkdir -p libboost
    - wget -nv https://boostorg.jfrog.io/artifactory/main/release/1.79.0/source/boost_1_79_0.tar.gz
    - tar xf boost_1_79_0.tar.gz
    - mv boost_1_79_0/* libboost/
    - export PREVIOUSDIR=$(pwd)
    - cd libboost && bash ./bootstrap.sh --prefix=/usr/ && ./b2 && ./b2 -j 4 --reconfigure target-os=android toolset=gcc-android link=static,shared variant=debug,release threading=multi install --prefix=/usr/lib/boost-arm64/ 
    - cd $PREVIOUSDIR
    - export ANDROID_HOME="/usr/lib/android-sdk/"
    - echo y | sdkmanager --sdk_root=/usr/lib/android-sdk --licenses
  script:
    - export BOOST_ROOT="/usr/lib/boost-arm64/"
    - apt-get update -y
    - git submodule update --init --depth 1 --recursive
    - bash -c "export PR_NUMBER=$PR_NUMBER; ./.ci/scripts/android/build.sh"
  artifacts:
    name: "android"
    paths:
      - artifacts/*
